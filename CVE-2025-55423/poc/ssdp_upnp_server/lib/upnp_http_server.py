from http.server import BaseHTTPRequestHandler, HTTPServer
import threading

class UPNPHTTPServerHandler(BaseHTTPRequestHandler):
    """
    A HTTP handler that serves the UPnP XML files.
    """

    # Handler for the GET requests
    def do_GET(self):
        if self.path == '/control?WANIPConnection':
            self.send_response(200)
            self.send_header('Content-type', 'application/xml')
            self.end_headers()
            self.wfile.write(self.get_wsd_xml().encode())
            return
        if self.path == '/gatedesc.xml':
            self.send_response(200)
            self.send_header('Content-type', 'application/xml')
            self.end_headers()
            self.wfile.write(self.get_device_xml().encode())
            return
        else:
            self.send_response(404)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            self.wfile.write(b"Not found.")
            return
    def do_POST(self):
        if self.path == self.server.payload_url:
            self.send_response(200)
            self.send_header('Content-type', 'application/xml')
            self.end_headers()
            self.wfile.write(self.get_wsd_xml().encode())
            return
        else:
            self.send_response(404)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            self.wfile.write(b"Not found.")
            return

    def get_device_xml(self):
        """
        Get the main device descriptor xml file.
        """
        xml = """
        <root xmlns="urn:schemas-upnp-org:device-1-0">
        <specVersion>
            <major>1</major>
            <minor>0</minor>
        </specVersion>
        <device>
            <deviceType>urn:schemas-upnp-org:device:InternetGatewayDevice:1</deviceType>
            <friendlyName>ipTIME Tester</friendlyName>
            <manufacturer>EFM Networks</manufacturer>
            <manufacturerURL>http://www.iptime.co.kr</manufacturerURL>
            <modelDescription>EFM Networks ipTIME Tester</modelDescription>
            <modelName>ipTIME Tester</modelName>
            <modelURL>http://www.iptime.co.kr</modelURL>
            <presentationURL>{presentation_url}</presentationURL>
            <UDN>uuid:{uuid}</UDN>
            <serviceList>
            <service>
                <serviceType>urn:schemas-upnp-org:service:Layer3Forwarding:1</serviceType>
                <serviceId>urn:upnp-org:serviceId:L3Forwarding1</serviceId>
                <SCPDURL>/x_layer3forwarding.xml</SCPDURL>
                <controlURL>/control?Layer3Forwarding</controlURL>
                <eventSubURL>/event?Layer3Forwarding</eventSubURL>
            </service>
            </serviceList>
        <deviceList>
            <device>
                <deviceType>urn:schemas-upnp-org:device:WANDevice:1</deviceType>
                    <friendlyName>WANDevice</friendlyName>
                    <manufacturer>EFM Networks</manufacturer>
                    <manufacturerURL>http://www.iptime.co.kr</manufacturerURL>
                    <modelDescription>EFM Networks ipTIME N5-r1</modelDescription>
                    <modelName>ipTIME N5-r1</modelName>
                    <modelURL>http://www.iptime.co.kr</modelURL>
                    <UDN>uuid:{uuid}</UDN>
                    <serviceList>
                        <service>
                            <serviceType>urn:schemas-upnp-org:service:WANCommonInterfaceConfig:1</serviceType>
                            <serviceId>urn:upnp-org:serviceId:WANCommonIFC1</serviceId>
                            <SCPDURL>/x_wancommoninterfaceconfig.xml</SCPDURL>
                            <controlURL>/control?WANCommonInterfaceConfig</controlURL>
                            <eventSubURL>/event?WANCommonInterfaceConfig</eventSubURL>
                        </service>
                    </serviceList>
            <deviceList>
                <device>
                    <deviceType>urn:schemas-upnp-org:device:WANConnectionDevice:1</deviceType>
                        <friendlyName>WAN Connection Device</friendlyName>
                        <manufacturer>EFM Networks</manufacturer>
                        <manufacturerURL>http://www.iptime.co.kr</manufacturerURL>
                        <modelDescription>EFM Networks ipTIME N5-r1</modelDescription>
                        <modelName>ipTIME N5-r1</modelName>
                        <modelURL>http://www.iptime.co.kr</modelURL>
                        <UDN>uuid:{uuid}</UDN>
                        <serviceList>
                        <service>
                            <serviceType>urn:schemas-upnp-org:service:WANIPConnection:1</serviceType>
                            <serviceId>urn:upnp-org:serviceId:WANIPConn1</serviceId>
                            <SCPDURL>/x_wanipconnection.xml</SCPDURL>
                            <controlURL>{payload_url}</controlURL>
                            <eventSubURL>/event?WANIPConnection</eventSubURL>
                        </service>
                    </serviceList>
                </device>
            </deviceList>
                </device>
                    <device>
                        <deviceType>urn:schemas-upnp-org:device:LANDevice:1</deviceType>
                        <friendlyName>LANDevice</friendlyName>
                        <manufacturer>EFM Networks</manufacturer>
                        <manufacturerURL>http://www.iptime.co.kr</manufacturerURL>
                        <modelDescription>EFM Networks ipTIME N5-r1</modelDescription>
                        <modelName>ipTIME N5-r1</modelName>
                        <modelURL>http://www.iptime.co.kr</modelURL>
                        <UDN>uuid:{uuid}</UDN>
                            <serviceList>
                                <service>
                                    <serviceType>urn:schemas-upnp-org:service:LANHostConfigManagement:1</serviceType>
                                    <serviceId>urn:upnp-org:serviceId:LANHostCfg1</serviceId>
                                    <SCPDURL>/x_lanhostconfigmanagement.xml</SCPDURL>
                                    <controlURL>/control?LANHostConfigManagement</controlURL>
                                    <eventSubURL>/event?LANHostConfigManagement</eventSubURL>
                                </service>
                            </serviceList>
                    </device>
        </deviceList>
</device>
</root>"""
        return xml.format(friendly_name=self.server.friendly_name,
                          manufacturer=self.server.manufacturer,
                          manufacturer_url=self.server.manufacturer_url,
                          model_description=self.server.model_description,
                          model_name=self.server.model_name,
                          model_number=self.server.model_number,
                          model_url=self.server.model_url,
                          serial_number=self.server.serial_number,
                          uuid=self.server.uuid,
                          presentation_url=self.server.presentation_url,
                          payload_url=self.server.payload_url)

    @staticmethod
    def get_wsd_xml():
        """
        Get the device WSD file.
        """
        return """
            <?xml version="1.0"?>
            <s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/" s:encodingStyle="http://schemas.xmlsoap.org/soap/encoding/">
            <s:Body><u:GetStatusInfoResponse xmlns:u="urn:schemas-upnp-org:service:WANIPConnection:1">
            <NewConnectionStatus>Connected</NewConnectionStatus>
            <NewLastConnectionError>ERROR_NONE</NewLastConnectionError>
            <NewUptime>11425652</NewUptime>
            </u:GetStatusInfoResponse>
            </s:Body></s:Envelope>"""


class UPNPHTTPServerBase(HTTPServer):
    """
    A simple HTTP server that knows the information about a UPnP device.
    """
    def __init__(self, server_address, request_handler_class):
        HTTPServer.__init__(self, server_address, request_handler_class)
        self.port = None
        self.friendly_name = None
        self.manufacturer = None
        self.manufacturer_url = None
        self.model_description = None
        self.model_name = None
        self.model_url = None
        self.serial_number = None
        self.uuid = None
        self.presentation_url = None
        self.payload_url = None


class UPNPHTTPServer(threading.Thread):
    """
    A thread that runs UPNPHTTPServerBase.
    """

    def __init__(self, port, friendly_name, manufacturer, manufacturer_url, model_description, model_name,
                 model_number, model_url, serial_number, uuid, presentation_url, payload_url):
        threading.Thread.__init__(self, daemon=True)
        self.server = UPNPHTTPServerBase(('', port), UPNPHTTPServerHandler)
        self.server.port = port
        self.server.friendly_name = friendly_name
        self.server.manufacturer = manufacturer
        self.server.manufacturer_url = manufacturer_url
        self.server.model_description = model_description
        self.server.model_name = model_name
        self.server.model_number = model_number
        self.server.model_url = model_url
        self.server.serial_number = serial_number
        self.server.uuid = uuid
        self.server.presentation_url = presentation_url
        self.server.payload_url = payload_url

    def run(self):
        self.server.serve_forever()
